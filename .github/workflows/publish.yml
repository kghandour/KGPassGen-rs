name: Publish Crate

on:
  workflow_run:
    workflows: ["audit-rust", "clippy", "test"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: publish-${{ github.ref_name || github.sha }}
  cancel-in-progress: true

jobs:
    publish:
        if: startsWith(github.ref, 'refs/tags/') || github.event.workflow_run.head_branch == null
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - uses: Swatinem/rust-cache@v2

            - name: Publish to crates.io
              run: cargo publish --token ${{secrets.CARGO_REGISTRY_TOKEN}}